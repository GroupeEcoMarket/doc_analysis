# Document Analysis Pipeline Configuration
# All configurable thresholds and parameters
# This file serves as a dashboard for any engineer joining the project

# ==========================================
# METADATA
# ==========================================

meta:
  version: 1.0
  description: "Document analysis pipeline parameters — functional & reproducible"

# ==========================================
# ENVIRONMENT OVERRIDES
# ==========================================

environment_overrides:
  allowed: true  # If an environment variable exists, it has priority over config.yaml

# ==========================================
# GEOMETRY NORMALIZATION
# ==========================================

geometry:
  # Capture Type Classification (SCAN vs PHOTO)
  # Automatically detects whether the input is a scanned document or a photo
  capture_classifier:
    enabled: true  # Enable/disable automatic capture type detection
    # Pixel value threshold (0-255) to consider a pixel as white.
    # Higher values (e.g., 250) are stricter and may misclassify slightly gray scans as photos.
    # Lower values (e.g., 240) are more lenient and may classify photos with bright backgrounds as scans.
    white_level_threshold: 245
    # Percentage of white pixels required to classify as SCAN.
    # Higher values (e.g., 0.80) require more white space, making classification stricter.
    # Lower values (e.g., 0.60) are more lenient and may misclassify photos with lots of white space.
    white_percentage_threshold: 0.70
    # If SCAN is detected, skip the intelligent crop step (doctr).
    # Scans typically don't need cropping, saving processing time.
    skip_crop_if_scan: true
  
  # Orientation Detection (ONNX model)
  # Detects and corrects document orientation (0°, 90°, 180°, 270°)
  orientation:
    # Minimum confidence threshold to accept the detected orientation.
    # Higher values (e.g., 0.85) are stricter and may skip correction on ambiguous documents.
    # Lower values (e.g., 0.60) are more lenient but may apply incorrect corrections.
    min_confidence: 0.70
    
  # Intelligent Crop (doctr)
  # Automatically crops the document from the background
  crop:
    enabled: true  # Enable/disable intelligent cropping
    # Minimum area ratio the document must occupy in the image to skip cropping.
    # If the document occupies less than this ratio, cropping will be applied.
    # Higher values (e.g., 0.90) are stricter and will crop more aggressively.
    # Lower values (e.g., 0.75) are more lenient and may leave more background.
    min_area_ratio: 0.85
    # Maximum margin ratio threshold for overcrop_risk flag.
    # If the detected crop margin exceeds this ratio (> 8% of an edge), a warning is raised.
    # Lower values (e.g., 0.05) are stricter and flag more potential overcrops.
    # Higher values (e.g., 0.12) are more lenient and may miss actual overcrop issues.
    max_margin_ratio: 0.08
    
  # Deskew (Angle Correction)
  # Corrects document rotation/angle skew
  deskew:
    enabled: true
    # Confidence threshold for applying angle correction.
    # Higher values (e.g., 0.5) make deskew stricter and avoid false positives on straight documents.
    # Lower values (e.g., 0.10) are more lenient but may apply unnecessary corrections.
    min_confidence: 0.20
    # Maximum acceptable angle (in degrees) for correction.
    # Angles beyond this threshold will not be corrected (may indicate a rotated scan).
    # Lower values (e.g., 10.0) are stricter and only correct small angles.
    # Higher values (e.g., 20.0) allow correction of more severe skews.
    max_angle: 15.0
    # Minimum angle threshold to apply deskew (ignore very small angles).
    # Prevents unnecessary corrections for near-perfect documents.
    # Higher values (e.g., 1.0) ignore more small angles, reducing processing.
    # Lower values (e.g., 0.2) are more sensitive and may correct minimal skews.
    min_angle: 0.5
    # Threshold for Hough line detection algorithm.
    # Increasing this value (e.g., 150) detects fewer lines, making angle detection more robust on clean documents.
    # Decreasing it (e.g., 50) can help on documents with sparse text or few lines.
    hough_threshold: 100
    
  # Image Quality Checks
  # Validates and enforces minimum quality standards
  quality:
    # Minimum contrast value after enhancement.
    # Documents below this threshold will be flagged as low_contrast_after_enhance.
    # Higher values (e.g., 70) are stricter and flag more low-contrast documents.
    # Lower values (e.g., 40) are more lenient but may accept poor quality images.
    min_contrast: 50
    # Minimum width (in pixels) for the final processed image.
    # Images below this width will be flagged as too_small_final.
    # Higher values (e.g., 1500) enforce higher resolution requirements.
    # Lower values (e.g., 1000) are more lenient but may accept low-resolution images.
    min_resolution_width: 1200
    # Minimum height (in pixels) for the final processed image.
    # Images below this height will be flagged as too_small_final.
    # Higher values (e.g., 2000) enforce higher resolution requirements.
    # Lower values (e.g., 1400) are more lenient but may accept low-resolution images.
    min_resolution_height: 1600

# ==========================================
# PDF PROCESSING
# ==========================================

pdf:
  # DPI (dots per inch) for PDF to image conversion.
  # Higher values (e.g., 400) produce higher quality images but increase file size and processing time.
  # Lower values (e.g., 200) are faster but may result in lower quality, especially for small text.
  dpi: 300
  # Minimum DPI threshold.
  # PDFs with lower DPI will be flagged or upscaled.
  # This ensures consistent quality across all processed documents.
  min_dpi: 300

# ==========================================
# QA FLAGS
# ==========================================

qa:
  # Quality Assurance thresholds for flagging potential issues
  # if they are not directly tied to the geometry parameters.

# ==========================================
# COLOMETRY NORMALIZATION
# ==========================================

colometry:
  enabled: false  # Enable/disable column structure normalization
  # Parameters to be defined: expected number of columns, column width thresholds, etc.
  # Example: min_column_width: 50  # Minimum width (in pixels) for a column to be considered valid

# ==========================================
# DOCUMENT CLASSIFICATION
# ==========================================

classification:
  # Document Type Classification
  # Classifies documents into types (e.g., "Attestation_CEE", "Facture", etc.)
  enabled: true  # Enable/disable document type classification
  # Minimum confidence threshold for OCR lines to be included in embeddings.
  # Higher values (e.g., 0.85) are stricter and only use high-confidence text.
  # Lower values (e.g., 0.60) are more lenient but may include incorrectly recognized text.
  min_confidence: 0.70
  # Classification confidence threshold to accept a prediction.
  # Predictions with confidence below this threshold will be rejected or marked as uncertain.
  # Higher values (e.g., 0.80) are stricter and only accept high-confidence classifications.
  # Lower values (e.g., 0.50) are more lenient but may accept incorrect classifications.
  classification_confidence_threshold: 0.60
  device: "cpu"  # or "cuda" if you have a GPU and want to use it
  # Maximum number of pages to process in a single batch.
  # Documents with more pages will be automatically split into multiple batches.
  # Higher values (e.g., 20) process more pages at once but may consume more memory.
  # Lower values (e.g., 5) use less memory but may create more overhead.
  max_pages_per_batch: 10

# ==========================================
# FEATURE EXTRACTION
# ==========================================

features:
  # OCR Results Filtering (Post-processing)
  # This section configures the filtering of OCR results AFTER they are returned by the OCR microservice.
  # It does NOT configure the OCR process itself, which is entirely managed by the isolated OCR service.
  # 
  # The OCR process configuration (PaddleOCR settings: language, GPU, MKLDNN, etc.) is located in:
  # services/ocr_service/config.yaml
  #
  # This section only controls:
  # - Whether to enable/disable OCR text extraction in the main pipeline
  # - The minimum confidence threshold for filtering OCR results (post-processing filter)
  ocr_filtering:
    enabled: true  # Enable/disable OCR text extraction in the main pipeline
    # Minimum confidence threshold for filtering OCR results AFTER they are returned by the OCR service.
    # This is a POST-PROCESSING filter applied to the OCR results, not a parameter of the OCR engine itself.
    # Higher values (e.g., 0.85) are stricter and only accept high-confidence text, reducing false positives.
    # Lower values (e.g., 0.60) are more lenient but may include incorrectly recognized text.
    min_confidence: 0.70
  
  # Checkbox Detection
  # Detects and classifies checkboxes (checked/unchecked)
  checkboxes:
    enabled: false  # Enable/disable checkbox detection
    # Confidence threshold for detecting a checkbox element.
    # Higher values (e.g., 0.75) are stricter and only detect clear checkboxes, reducing false positives.
    # Lower values (e.g., 0.50) are more lenient but may detect non-checkbox elements.
    min_confidence: 0.60
    # Threshold for considering a checkbox as "checked".
    # Value between 0.0 and 1.0 representing the fill ratio or confidence of checked state.
    # Higher values (e.g., 0.7) are stricter and only mark clearly checked boxes.
    # Lower values (e.g., 0.3) are more lenient but may mark partially filled boxes as checked.
    checked_threshold: 0.5

# ==========================================
# PERFORMANCE
# ==========================================

performance:
  # Minimum number of items (pages/images) required to trigger parallel processing.
  # Below this threshold, sequential processing is used to avoid the overhead of process creation.
  # Higher values (e.g., 5) reduce parallelization overhead but may miss opportunities for speedup.
  # Lower values (e.g., 1) parallelize more aggressively but may create unnecessary overhead.
  # Optimal value depends on CPU, I/O, and document complexity.
  parallelization_threshold: 2
  # Load models only when needed (lazy loading).
  # When true, models are loaded on first use, reducing initial startup time and memory usage.
  # When false, all models are loaded at startup, increasing initial memory but ensuring models are ready.
  lazy_load_models: true

# ==========================================
# OUTPUT
# ==========================================

output:
  # Save the original input image before any transformations.
  # Useful for debugging, comparison, or archival purposes.
  save_original: true
  # Save the transformed/processed image after all transformations.
  # This is typically the final output used for downstream processing.
  save_transformed: true
  # Save quality assurance flags as metadata.
  # Flags indicate potential issues (low contrast, overcrop risk, etc.) for review.
  save_qa_flags: true
  # Save the list of transformations applied to the document.
  # Useful for audit trails, debugging, and understanding the processing pipeline.
  save_transforms: true
  # Output image format: "png" (lossless, larger files) or "jpg" (lossy, smaller files).
  # PNG is recommended for documents with text and sharp edges.
  # JPEG is suitable for photos but may introduce compression artifacts on text.
  image_format: "png"
  # JPEG quality (1-100) if image_format is "jpg".
  # Higher values (e.g., 95) produce better quality but larger files.
  # Lower values (e.g., 80) produce smaller files but may introduce visible compression artifacts.
  # Only used when image_format is "jpg".
  jpeg_quality: 95

# ==========================================
# OCR SERVICE CONFIGURATION
# ==========================================

ocr_service:
  # Configuration pour la communication avec le microservice OCR isolé
  # Le microservice OCR est déployé séparément et écoute la queue ocr-queue
  
  # Nom de la queue Dramatiq pour le microservice OCR
  # Cette queue doit correspondre à celle configurée dans services/ocr_service/actors.py
  queue_name: 'ocr-queue'
  
  # Timeout en millisecondes pour attendre le résultat d'une tâche OCR
  # Si le microservice ne répond pas dans ce délai, une FeatureExtractionError sera levée
  # Défaut: 30000 (30 secondes)
  timeout_ms: 30000
  
  # Nombre de tentatives en cas d'échec
  # Défaut: 3
  max_retries: 3

# ==========================================
# DRAMATIQ CONFIGURATION
# ==========================================

dramatiq:
  # Dead Letter Queue (DLQ) Configuration
  # Dramatiq gère automatiquement la DLQ avec le nom 'dramatiq:dead_letter'
  # Les tâches qui échouent après max_retries sont automatiquement envoyées vers cette queue
  # Permet de récupérer et analyser les tâches échouées pour debugging ou rejeu
  
  # Durée de vie des messages dans la DLQ (en millisecondes)
  # Défaut: 604800000 (7 jours). Les messages plus anciens sont automatiquement supprimés
  dead_message_ttl: 604800000  # 7 jours en millisecondes
  
  # Configuration des retries par défaut pour les actors
  # Note: Les actors peuvent surcharger ces valeurs avec leurs propres paramètres
  default_max_retries: 3  # Nombre de tentatives avant envoi en DLQ
  default_time_limit: 300000  # Timeout par défaut en millisecondes (5 minutes)
  
  # Configuration du verrou d'initialisation des workers (FileLock)
  # Timeout en secondes pour l'acquisition du verrou inter-processus lors de l'initialisation
  # des modèles. Si un worker ne peut pas acquérir le verrou dans ce délai, une exception
  # sera levée. Défaut: 60 secondes.
  worker_init_lock_timeout: 60  # en secondes
  
  # Timeout global pour la finalisation des documents (en secondes)
  # Si ce timeout est atteint, la tâche de finalisation agrège les résultats disponibles
  # et retourne un résultat partiel plutôt que d'échouer complètement.
  # Défaut: 300 secondes (5 minutes)
  finalization_timeout_seconds: 300  # 5 minutes

